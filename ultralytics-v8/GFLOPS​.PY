import torch
from thop import profile
from ultralytics import YOLO
import os


def calculate_yolov8_gflops_with_config(cfg_path, model_path, input_size=(640, 640)):
    """
    ä½¿ç”¨é…ç½®æ–‡ä»¶è®¡ç®—YOLOv8æ¨¡å‹çš„GFLOPS

    å‚æ•°:
        cfg_path: æ¨¡å‹é…ç½®æ–‡ä»¶è·¯å¾„
        model_path: æ¨¡å‹æƒé‡æ–‡ä»¶è·¯å¾„
        input_size: è¾“å…¥å›¾åƒå°ºå¯¸ (é«˜åº¦, å®½åº¦)
    """
    try:
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(cfg_path):
            raise FileNotFoundError(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {cfg_path}")
        if not os.path.exists(model_path):
            raise FileNotFoundError(f"æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {model_path}")

        print("æ­£åœ¨åŠ è½½æ¨¡å‹é…ç½®å’Œæƒé‡...")
        print(f"é…ç½®æ–‡ä»¶: {cfg_path}")
        print(f"æ¨¡å‹æ–‡ä»¶: {model_path}")

        # æ–¹æ³•1: ä½¿ç”¨é…ç½®æ–‡ä»¶æ„å»ºæ¨¡å‹ï¼Œç„¶ååŠ è½½æƒé‡
        model = YOLO(cfg_path)  # å…ˆé€šè¿‡é…ç½®æ–‡ä»¶æ„å»ºæ¨¡å‹ç»“æ„
        model.load(model_path)  # ç„¶ååŠ è½½è®­ç»ƒå¥½çš„æƒé‡

        # è·å–PyTorchæ¨¡å‹
        pytorch_model = model.model
        pytorch_model.eval()  # è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼

        # åˆ›å»ºè™šæ‹Ÿè¾“å…¥
        batch_size = 1
        channels = 3
        height, width = input_size
        dummy_input = torch.randn(batch_size, channels, height, width)

        # è®¡ç®—FLOPså’Œå‚æ•°æ•°é‡
        print("æ­£åœ¨è®¡ç®—GFLOPSå’Œå‚æ•°é‡...")
        flops, params = profile(pytorch_model, inputs=(dummy_input,), verbose=False)

        # è½¬æ¢ä¸ºGFLOPS
        gflops = flops / 1e9

        # æ‰“å°è¯¦ç»†ç»“æœ
        print(f"\n=== YOLOv8æ¨¡å‹è®¡ç®—å¤æ‚åº¦åˆ†æ ===")
        print(f"é…ç½®æ–‡ä»¶: {os.path.basename(cfg_path)}")
        print(f"æ¨¡å‹æ–‡ä»¶: {os.path.basename(model_path)}")
        print(f"è¾“å…¥å°ºå¯¸: {input_size[1]}x{input_size[0]}")
        print(f"FLOPs: {flops:,.0f}")
        print(f"GFLOPS: {gflops:.2f} G")
        print(f"å‚æ•°é‡: {params:,.0f}")
        print(f"å‚æ•°é‡: {params / 1e6:.2f} M")

        return gflops, params

    except Exception as e:
        print(f"è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        # å°è¯•å¤‡é€‰æ–¹æ¡ˆ
        return calculate_gflops_fallback(model_path, input_size)


def calculate_gflops_fallback(model_path, input_size=(640, 640)):
    """
    å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥åŠ è½½æ¨¡å‹æ–‡ä»¶è®¡ç®—GFLOPS
    """
    try:
        print("å°è¯•å¤‡é€‰æ–¹æ¡ˆ...")
        # ç›´æ¥åŠ è½½æ¨¡å‹
        model = YOLO(model_path)
        pytorch_model = model.model
        pytorch_model.eval()

        # åˆ›å»ºè™šæ‹Ÿè¾“å…¥
        dummy_input = torch.randn(1, 3, input_size[0], input_size[1])

        # è®¡ç®—FLOPs
        flops, params = profile(pytorch_model, inputs=(dummy_input,), verbose=False)
        gflops = flops / 1e9

        print(f"\n=== å¤‡é€‰æ–¹æ¡ˆè®¡ç®—ç»“æœ ===")
        print(f"GFLOPS: {gflops:.2f} G")
        print(f"å‚æ•°é‡: {params / 1e6:.2f} M")

        return gflops, params

    except Exception as e:
        print(f"å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥: {e}")
        return None, None


def get_model_info(model_path):
    """
    è·å–æ¨¡å‹åŸºæœ¬ä¿¡æ¯
    """
    try:
        # åŠ è½½æ¨¡å‹ä½†ä¸åˆå§‹åŒ–ï¼ˆå¿«é€Ÿè·å–ä¿¡æ¯ï¼‰
        model = YOLO(model_path, task='detect')
        print(f"\n=== æ¨¡å‹åŸºæœ¬ä¿¡æ¯ ===")
        print(f"æ¨¡å‹ç±»å‹: {model.task}")
        print(f"æ¨¡å‹ç±»åˆ«æ•°: {model.model.model[-1].nc if hasattr(model.model, 'model') else 'æœªçŸ¥'}")

        # å°è¯•è·å–è¾“å…¥å°ºå¯¸
        if hasattr(model, 'args') and hasattr(model.args, 'imgsz'):
            print(f"è®­ç»ƒè¾“å…¥å°ºå¯¸: {model.args.imgsz}")

    except Exception as e:
        print(f"è·å–æ¨¡å‹ä¿¡æ¯å¤±è´¥: {e}")


# ä¸»ç¨‹åº
if __name__ == "__main__":
    # æ–‡ä»¶è·¯å¾„
    cfg_path = r"F:\yolov8_lichi\ultralytics-main\ultralytics\cfg\models\v8\yolov8-AC-head.yaml"
    model_path = r"F:\yolov8_lichi\runs\detect\yolov8_ACmix_head\weights\best.pt"

    print("å¼€å§‹è®¡ç®—YOLOv8æ¨¡å‹å¤æ‚åº¦...")

    # å…ˆè·å–æ¨¡å‹åŸºæœ¬ä¿¡æ¯
    get_model_info(model_path)

    # è®¡ç®—GFLOPS
    gflops, params = calculate_yolov8_gflops_with_config(cfg_path, model_path)

    if gflops is not None:
        print(f"\nğŸ‰ è®¡ç®—å®Œæˆ!")
        print(f"æ‚¨çš„YOLOv8æ¨¡å‹çš„GFLOPSä¸º: {gflops:.2f} G")
        print(f"æ¨¡å‹å‚æ•°é‡ä¸º: {params / 1e6:.2f} M")

        # ä¸æ ‡å‡†YOLOv8æ¨¡å‹å¯¹æ¯”
        print(f"\n=== ä¸æ ‡å‡†YOLOv8æ¨¡å‹å¯¹æ¯” ===")
        standard_gflops = {
            'yolov8n': 8.9,
            'yolov8s': 28.8,
            'yolov8m': 79.3,
            'yolov8l': 165.7,
            'yolov8x': 258.5
        }

        closest_model = min(standard_gflops.items(), key=lambda x: abs(x[1] - gflops))
        print(f"æœ€æ¥è¿‘çš„æ ‡å‡†æ¨¡å‹: {closest_model[0]} ({closest_model[1]:.1f} GFLOPS)")
        print(
            f"æ‚¨çš„æ¨¡å‹æ¯”{closest_model[0]} {'å¤§' if gflops > closest_model[1] else 'å°'} {abs(gflops - closest_model[1]):.1f} GFLOPS")

    else:
        print("âŒ è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯")